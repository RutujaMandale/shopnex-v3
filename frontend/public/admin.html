<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin — ShopNex</title>
  <link rel="stylesheet" href="/css/style.css"/>
</head>
<body>
<nav class="navbar">
  <a href="/index.html" class="logo">Shop<span>Nex</span></a>
  <div class="nav-links">
    <a href="/index.html">Home</a>
    <span id="adminUserDisplay" style="color:#777;display:none"></span>
    <button class="logout-btn" id="logoutBtn" style="display:none" type="button">Logout</button>
  </div>
</nav>

<!-- Login Section -->
<section class="admin-login-page" id="loginSection">
  <div class="login-box">
    <h2>Admin Login</h2>
    <p>This page is restricted to administrators.</p>
    <p class="error-msg" id="loginError" style="display:none;color:red"></p>
    <input type="text" id="username" placeholder="Username" autocomplete="off"/>
    <input type="password" id="password" placeholder="Password" autocomplete="off"/>
    <button type="button" class="btn-primary" id="loginBtn" style="width:100%">Login</button>
  </div>
</section>

<!-- Dashboard Section -->
<section class="admin-page" id="dashboardSection" style="display:none">
  <div class="admin-header">
    <div>
      <h1>Orders Dashboard</h1>
      <p style="color:#777;">Manage and view all customer orders</p>
    </div>
  </div>
  <div class="stats-grid">
    <div class="stat-card"><div class="stat-num" id="statOrders">0</div><div class="stat-label">Total Orders</div></div>
    <div class="stat-card"><div class="stat-num" id="statRevenue">$0.00</div><div class="stat-label">Total Revenue</div></div>
    <div class="stat-card"><div class="stat-num" id="statProducts">6</div><div class="stat-label">Products</div></div>
  </div>
  <div id="ordersContainer">
    <p style="text-align:center;color:#777;padding:40px;">Loading orders...</p>
  </div>
</section>

<footer><p>&copy; 2025 ShopNex. All rights reserved.</p></footer>

<script>
var adminToken = null;

async function doLogin() {
  var username = document.getElementById('username').value.trim();
  var password = document.getElementById('password').value;
  var errorEl = document.getElementById('loginError');
  var btn = document.getElementById('loginBtn');

  if (!username || !password) {
    errorEl.textContent = 'Please enter username and password.';
    errorEl.style.display = 'block';
    return;
  }

  btn.textContent = 'Logging in...';
  btn.disabled = true;

  try {
    var res = await fetch('/api/admin/login', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({username: username, password: password})
    });
    var data = await res.json();
    if (data.token) {
      adminToken = data.token;
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('dashboardSection').style.display = 'block';
      document.getElementById('logoutBtn').style.display = 'inline-block';
      document.getElementById('adminUserDisplay').textContent = 'Welcome, ' + username;
      document.getElementById('adminUserDisplay').style.display = 'inline';
      loadDashboard();
    } else {
      errorEl.textContent = data.error || 'Invalid credentials.';
      errorEl.style.display = 'block';
      btn.textContent = 'Login';
      btn.disabled = false;
    }
  } catch(err) {
    errorEl.textContent = 'Login failed: ' + err.message;
    errorEl.style.display = 'block';
    btn.textContent = 'Login';
    btn.disabled = false;
  }
}

async function loadDashboard() {
  var headers = {'Authorization': 'Bearer ' + adminToken};

  try {
    var statsRes = await fetch('/api/admin/stats', {headers: headers});
    var statsText = await statsRes.text();
    var stats = JSON.parse(statsText);
    document.getElementById('statOrders').textContent = stats.totalOrders || 0;
    document.getElementById('statRevenue').textContent = '$' + parseFloat(stats.totalRevenue || 0).toFixed(2);
    document.getElementById('statProducts').textContent = stats.totalProducts || 0;
  } catch(err) {
    console.error('Stats error:', err);
  }

  try {
    var ordersRes = await fetch('/api/admin/orders', {headers: headers});
    var ordersText = await ordersRes.text();
    var orders = JSON.parse(ordersText);
    var container = document.getElementById('ordersContainer');

    if (!orders.length) {
      container.innerHTML = '<p style="text-align:center;color:#777;padding:40px;">No orders yet.</p>';
      return;
    }

    var rows = '';
    orders.forEach(function(o) {
      rows += '<tr><td>#' + o.id + '</td><td>' + o.customer_name + '</td><td>' + o.customer_email + '</td><td>' + o.customer_address + '</td><td>$' + parseFloat(o.total_amount).toFixed(2) + '</td><td>' + (o.items || '—') + '</td><td><span class="badge badge-' + o.payment_status + '">' + o.payment_status + '</span></td><td>' + new Date(o.created_at).toLocaleDateString() + '</td></tr>';
    });

    container.innerHTML = '<table class="orders-table"><thead><tr><th>ID</th><th>Customer</th><th>Email</th><th>Address</th><th>Total</th><th>Items</th><th>Status</th><th>Date</th></tr></thead><tbody>' + rows + '</tbody></table>';
  } catch(err) {
    document.getElementById('ordersContainer').innerHTML = '<p style="color:red;text-align:center;padding:40px;">Error: ' + err.message + '</p>';
  }
}

document.getElementById('loginBtn').addEventListener('click', function(e) {
  e.preventDefault();
  doLogin();
});

document.getElementById('password').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') { e.preventDefault(); doLogin(); }
});

document.getElementById('logoutBtn').addEventListener('click', function(e) {
  e.preventDefault();
  adminToken = null;
  document.getElementById('loginSection').style.display = 'flex';
  document.getElementById('dashboardSection').style.display = 'none';
  document.getElementById('logoutBtn').style.display = 'none';
  document.getElementById('adminUserDisplay').style.display = 'none';
  document.getElementById('username').value = '';
  document.getElementById('password').value = '';
});
</script>
</body>
</html>